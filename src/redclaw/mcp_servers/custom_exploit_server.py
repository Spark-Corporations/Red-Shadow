"""
Custom Exploit MCP Server — Execute custom Python/Bash exploit scripts.
"""

from __future__ import annotations

import os
from typing import Any

from .base import BaseMCPServer, ToolSchema


class CustomExploitServer(BaseMCPServer):
    def __init__(self, session_manager=None):
        super().__init__(session_manager, name="custom_exploit")

    def get_tools(self) -> list[ToolSchema]:
        return [
            ToolSchema(
                name="run_python_exploit",
                description="Execute a custom Python exploit script",
                parameters={
                    "type": "object",
                    "properties": {
                        "script_path": {"type": "string", "description": "Path to the Python exploit script"},
                        "target": {"type": "string", "description": "Target for the exploit"},
                        "args": {"type": "string", "description": "Additional arguments"},
                    },
                    "required": ["script_path"],
                },
            ),
            ToolSchema(
                name="run_bash_exploit",
                description="Execute a custom Bash exploit script",
                parameters={
                    "type": "object",
                    "properties": {
                        "script_path": {"type": "string", "description": "Path to the Bash script"},
                        "target": {"type": "string", "description": "Target"},
                        "args": {"type": "string", "description": "Additional arguments"},
                    },
                    "required": ["script_path"],
                },
            ),
        ]

    def build_command(self, tool_name: str = "run_python_exploit", **params) -> str:
        script = params.get("script_path", "")
        target = params.get("target", "")
        args = params.get("args", "")

        if not script:
            raise ValueError("script_path is required")

        # Security: only allow scripts from the exploits directory
        if ".." in script or script.startswith("/etc") or script.startswith("/dev"):
            raise ValueError(f"Suspicious script path blocked: {script}")

        if tool_name == "run_python_exploit":
            parts = ["python3", script]
        else:
            parts = ["bash", script]

        if target:
            parts.append(target)
        if args:
            parts.append(args)

        return " ".join(parts)

    def parse_output(self, tool_name: str, raw_output: str) -> dict[str, Any]:
        # Custom exploits have unpredictable output — return raw
        success_indicators = ["success", "pwned", "shell", "flag", "root"]
        likely_success = any(s in raw_output.lower() for s in success_indicators)
        return {
            "output": raw_output[:8000],
            "likely_success": likely_success,
        }
